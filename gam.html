<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Car Obstacle Game - Extreme Mode</title>
  <style>
    * {
      padding: 0;
      margin: 0;
      color: whitesmoke;
    }
    #lk {
      margin: 0;
      padding: 0;
      height: 100vh;
      width: 100vw;
      overflow: hidden;
      background: url('https://i.pinimg.com/originals/e2/22/31/e22231fcde8429973891b6f858c75839.gif') no-repeat center center/cover;
    }
    #player {
      position: absolute;
      width: 50px;
      height: 50px;
      background-color: red;
      left: 50%;
      transform: translateX(-50%);
      bottom: 20px;
      border-radius: 5px;
      box-shadow: 0 0 10px rgba(0, 0, 0, 0.5);
    }
    .obstacle {
      position: absolute;
      width: 50px;
      height: 50px;
      border-radius: 5px;
      box-shadow: 0 0 10px rgba(0, 0, 0, 0.8);
    }
    .normal { background-color: greenyellow; }
    .fast { background-color: orange; }
    .bouncing { background-color: whitesmoke; }
    .reverse { background-color: deeppink; }
    #scoreDisplay {
      position: absolute;
      top: 10px;
      left: 60%;
      transform: translateX(-50%);
      color: goldenrod;
      font-family: 'Arial', sans-serif;
      font-size: 20px;
      font-weight: bold;
      background: rgba(0, 0, 0, 0.5);
      padding: 10px;
      border-radius: 10px;
    }
    #leaderboard {
      display: none;
      position: absolute;
      top: 100px;
      left: 50%;
      transform: translateX(-50%);
      background: black;
      padding: 20px;
      border-radius: 15px;
      box-shadow: 0 0 15px rgba(0,0,0,0.5);
      z-index: 9999;
    }
    #leaderboard table {
      border-collapse: collapse;
      width: 100%;
      font-family: Arial, sans-serif;
    }
    #leaderboard th, #leaderboard td {
      border: 1px solid #ccc;
      padding: 8px 12px;
      text-align: center;
    }
    #showLeaderboard {
      position: absolute;
      top: 10px;
      right: 30px;
      padding: 10px 20px;
      background: navy;
      color: red;
      border: none;
      border-radius: 8px;
      cursor: pointer;
    }
    #box {
      border: 5px solid black;
      height: calc(100vh - 54px);
      width: calc(100vw - 10px);
      position: relative;
      left: 0px;
      top: 54px;
      animation: anime 13s linear infinite;
    }
    #m {
      color: goldenrod;
      position: fixed;
      bottom: 0px;
      animation: anm 3s linear infinite;
    }
    .marq {
      position: fixed;
      bottom: 0%;
      background-color: green;
    }
    @keyframes an2 {
      from { color: red; }
      to { color: greenyellow; }
    }
    @keyframes anm {
      from { border: black 4px solid; }
      to { border: blue 4px solid; }
    }
    #button {
      width: 200px;
      height: 50px;
      background-color: goldenrod;
      color: whitesmoke;
      font-size: 36px;
      font-weight: bold;
      align-items: center;
      justify-content: center;
      border-radius: 15px;
      cursor: pointer;
      animation: blink 1s infinite alternate;
      font-style: italic;
      text-decoration: none;
      position: fixed;
      top: 415px;
      left: 50%;
      transform: translateX(-50%);
    }
    @keyframes blink {
      from { color: whitesmoke; }
      to { color: red; }
    }
    #l {
      font-size: 50px;
      font-family: algerian;
      position: fixed;
      top: 300px;
      left: 50%;
      transform: translateX(-50%);
      color: brown;
      height: 100px;
      width: 950px;
    }
    #yl {
      position: fixed;
      top: 0%;
      left: 300px;
      width: 800px;
      height: 100px;
    }
    #bt {
      width: 200px;
      height: 50px;
      background-color: greenyellow;
      color: plum;
      font-size: 20px;
      font-weight: bold;
      align-items: center;
      justify-content: center;
      border-radius: 15px;
      cursor: pointer;
      font-style: italic;
      text-decoration: none;
      position: fixed;
      top: 500px;
      left: 50%;
      transform: translateX(-50%);
    }
    #but {
      width: 245px;
      height: 50px;
      background-color: blueviolet;
      color: black;
      font-size: 20px;
      font-weight: bold;
      align-items: center;
      justify-content: center;
      border-radius: 15px;
      cursor: pointer;
      font-style: italic;
      text-decoration: none;
      position: fixed;
      top: 575px;
      left: 50%;
      transform: translateX(-50%);
    }
  </style>
</head>
<body id="lk">
  <div id="one">
  </div>
  <div id="box"></div>
  <marquee class="marq" bgcolor="Green" direction="left" loop="">
    <div class="geek1">Press ArrowUp or ArrowDown key to move! HOPE YOU LOVED THE GAME.VISIT AGAIN!</div>
  </marquee>
  <audio id="bgMusic" src="victory-awaits-in-the-gaming-universe_astronaut-265184.mp3" loop autoplay></audio>
  <audio id="coinSound" src="coin.wav"></audio>
  <audio id="crashSound" src="crash.wav"></audio>
  <div id="player"></div>
  <div id="scoreDisplay">Score: 0 | Lives: 3</div>
  <button id="showLeaderboard">Show Leaderboard</button>
  <div id="leaderboard">
    <h3>Top Players</h3>
    <table>
      <thead>
        <tr><th>Username</th><th>Highest Score</th></tr>
      </thead>
      <tbody id="leaderboardBody"></tbody>
    </table>
  </div>
  <div id="gameOverOptions" style="display:none; position:fixed; top:50%; left:50%; transform:translate(-50%, -50%);
  background:#222; padding:30px; border-radius:15px; box-shadow:0 0 20px rgba(0,0,0,0.7); text-align:center; z-index:10000;">
    <h2 style="color:white; margin-bottom:20px;">Game Over!</h2>
    <button onclick="reviveWithAd()" style="padding:10px 20px; margin: 10px; font-size: 16px; cursor: pointer; border-radius: 5px; background-color: #4CAF50; color: white; border: none;">Watch Ad for a Revive!</button>
    <button onclick="location.reload()" style="padding:10px 20px; margin-right:20px; background:limegreen; border:none; border-radius:8px; color:white; font-size:16px; cursor:pointer;">
      Restart
    </button>
    <a href="s2.html" style="padding:10px 20px; background:crimson; border:none; border-radius:8px; color:white; font-size:16px; text-decoration:none;">
      Quit
    </a>
  </div>
  <script>
    let gameRunning = true;
    class Stack {
      constructor() { this.items = []; }
      push(item) { this.items.push(item); }
      pop() { return this.items.pop(); }
    }
    class Node {
      constructor(data) { this.data = data; this.next = null; }
    }
    class LinkedList {
      constructor() { this.head = null; }
      add(data) {
        const newNode = new Node(data);
        if (!this.head) this.head = newNode;
        else {
          let current = this.head;
          while (current.next) current = current.next;
          current.next = newNode;
        }
      }
    }
    class TreeNode {
      constructor(score) { this.score = score; this.left = null; this.right = null; }
    }
    class BinaryTree {
      constructor() { this.root = null; }
      insert(score) {
        const newNode = new TreeNode(score);
        if (!this.root) this.root = newNode;
        else this.#insertNode(this.root, newNode);
      }
      #insertNode(node, newNode) {
        if (newNode.score < node.score) node.left ? this.#insertNode(node.left, newNode) : node.left = newNode;
        else node.right ? this.#insertNode(node.right, newNode) : node.right = newNode;
      }
      findMax(node = this.root) { return node?.right ? this.findMax(node.right) : node?.score ?? 0; }
    }
    const lanes = [100, 220, 340, 460];
    let currentLane = 1;
    const player = document.getElementById("player");
    let playerY = lanes[currentLane];
    player.style.top = `${playerY}px`;
    const scoreStack = new Stack();
    const obstacleList = new LinkedList();
    const highScoreTree = new BinaryTree();
    let score = 0, lives = 3;
    const coinSound = document.getElementById("coinSound");
    const crashSound = document.getElementById("crashSound");
    document.addEventListener("keydown", (e) => {
      if (e.key === "ArrowUp" && currentLane > 0) currentLane--;
      if (e.key === "ArrowDown" && currentLane < lanes.length - 1) currentLane++;
      playerY = lanes[currentLane];
      player.style.top = `${playerY}px`;
    });
    function updateScore() {
      score += 5;
      scoreStack.push(score);
      coinSound.currentTime = 0;
      coinSound.play();
    }
    function handleCollision() {
      crashSound.currentTime = 0;
      crashSound.play();
      if (lives > 0) lives--;
      if (lives <= 0) {
        const username = localStorage.getItem("username") || "Guest";
        const finalScore = scoreStack.pop() || 0;
        fetch("save_score.php", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ username: username, score: finalScore })
        })
        .then(res => res.json())
        .then(data => {
          updateLeaderboard();
          setTimeout(() => {
            alert(`Game Over! Highest Score for ${username}: ${data.highest}`);
            gameRunning = false;
            document.getElementById("gameOverOptions").style.display = "block";
          }, 300);
        })
        .catch(err => {
          console.error("Score save error:", err);
          alert("Game Over! But couldn't fetch highest score.");
          gameRunning = false;
          document.getElementById("bgMusic").pause();
          document.getElementById("gameOverOptions").style.display = "block";
        });
      }
    }
    function createObstacle() {
      const types = [
        { type: "normal", speed: 3, bounce: false, reverse: false },
        { type: "fast", speed: 10, bounce: false, reverse: false },
        { type: "bouncing", speed: 5, bounce: true, reverse: false },
        { type: "reverse", speed: 12, bounce: false, reverse: true },
      ];
      const obstacleData = types[Math.floor(Math.random() * types.length)];
      const obstacle = {
        x: obstacleData.reverse ? -200 : window.innerWidth,
        y: lanes[Math.floor(Math.random() * lanes.length)],
        speed: obstacleData.speed,
        type: obstacleData.type,
        bounce: obstacleData.bounce,
        reverse: obstacleData.reverse,
        dy: obstacleData.bounce ? 3 : 0,
        width: 200,
        height: 200,
        div: document.createElement("div")
      };
      obstacle.div.className = `obstacle ${obstacle.type}`;
      obstacle.div.style.left = `${obstacle.x}px`;
      obstacle.div.style.top = `${obstacle.y}px`;
      document.body.appendChild(obstacle.div);
      obstacleList.add(obstacle);
    }
    function moveObstacles(playerRect) {
      let current = obstacleList.head;
      let prev = null;
      while (current) {
        let obstacle = current.data;
        if (obstacle.reverse) obstacle.x += obstacle.speed;
        else obstacle.x -= obstacle.speed;
        if (obstacle.bounce) {
          obstacle.y += obstacle.dy;
          if (obstacle.y <= 0 || obstacle.y >= window.innerHeight - obstacle.height) {
            obstacle.dy *= -1;
          }
        }
        obstacle.div.style.left = `${obstacle.x}px`;
        obstacle.div.style.top = `${obstacle.y}px`;
        if (
          playerRect.left < obstacle.x + obstacle.width &&
          playerRect.right > obstacle.x &&
          playerRect.top < obstacle.y + obstacle.height &&
          playerRect.bottom > obstacle.y
        ) {
          handleCollision();
          obstacle.div.remove();
          if (prev) prev.next = current.next;
          else obstacleList.head = current.next;
        } else if ((obstacle.reverse && obstacle.x > window.innerWidth + 200) || (!obstacle.reverse && obstacle.x < -200)) {
          updateScore();
          obstacle.div.remove();
          if (prev) prev.next = current.next;
          else obstacleList.head = current.next;
        } else {
          prev = current;
        }
        current = current.next;
      }
    }
    function updateLeaderboard() {
      fetch("leaderboard.php")
        .then(res => res.json())
        .then(data => {
          const tableBody = document.getElementById("leaderboardBody");
          tableBody.innerHTML = "";
          data.forEach(entry => {
            const row = document.createElement("tr");
            row.innerHTML = `<td>${entry.username}</td><td>${entry.highest}</td>`;
            tableBody.appendChild(row);
          });
          document.getElementById("leaderboard").style.display = "block";
        })
        .catch(err => console.error("Error loading leaderboard:", err));
    }
    const button = document.getElementById("showLeaderboard");
    const leaderboard = document.getElementById("leaderboard");
    button.addEventListener("click", () => {
      if (leaderboard.style.display === "block") {
        leaderboard.style.display = "none";
        button.textContent = "Show Leaderboard";
      } else {
        updateLeaderboard();
        button.textContent = "Hide Leaderboard";
      }
    });
    function gameLoop() {
      if (!gameRunning) return;
      const playerRect = player.getBoundingClientRect();
      moveObstacles(playerRect);
      document.getElementById("scoreDisplay").innerHTML = `Score: ${score} | Lives: ${lives}`;
      requestAnimationFrame(gameLoop);
    }
    setInterval(createObstacle, 500);
    gameLoop();
    function showRewardedAd(onComplete, onFailed) {
      console.log("Ad request initiated...");
      setTimeout(() => {
        console.log("Ad completed successfully!");
        onComplete(true);
      }, 2000);
    }
    function handleReward() {
      lives = 3;
      score = score;
      gameRunning = true;
      document.getElementById("gameOverOptions").style.display = "none";
      gameLoop();
      console.log("Player rewarded! Lives restored.");
    }
    function reviveWithAd() {
      showRewardedAd(
        (success) => {
          if (success) {
            handleReward();
          } else {
            alert("Ad failed to load. Please try again.");
          }
        },
        () => {
          alert("Ad could not be loaded. Please try again.");
        }
      );
    }
    function gameOver() {
      gameRunning = false;
      document.getElementById("gameOverOptions").style.display = "block";
    }
  </script>
</body>
</html>
